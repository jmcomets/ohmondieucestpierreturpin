"use strict";(function(){var t=function(){this.acceptedIds={};this.keyPressed={};this.listeners={press:[],release:[]}};t.prototype.disable=function(){this.acceptedIds={}};t.prototype.accept=function(t){for(var e=0;e<t.length;e++){this.acceptedIds[t[e]]=true}};t.prototype.bindTo=function(t){var e=this;var s=function(t,s){var o=e.listeners[t];for(var i=0;i<o.length;i++){o[i](s)}};t.on("keydown",function(t){var o=t.which;if(e.keyPressed[o]){return}e.keyPressed[o]=true;if(e.acceptedIds[o]){s("press",o)}});t.on("keyup",function(t){var o=t.which;e.keyPressed[o]=false;if(e.acceptedIds[o]){s("release",o)}})};t.prototype.onPress=function(t){this.listeners.press.push(t)};t.prototype.onRelease=function(t){this.listeners.release.push(t)};var e=function(t,e){this.id=t;this.text=e;this.listeners=[];this.statusCode="";this.$e=this.makeElement();this.render()};e.prototype.appendTo=function(t){this.$e.appendTo(t)};e.prototype.onHit=function(t){this.listeners.push(t)};e.prototype.notifyListeners=function(t){var e=this;for(var s=0;s<e.listeners.length;s++){e.listeners[s](e.id,t)}};e.prototype.clearStatus=function(){this.statusCode="";this.render()};e.prototype.setStatus=function(t){this.statusCode=t;this.render()};e.prototype.render=function(){var t=["btn","btn-default","btn-lg"];this.$e.attr("class",t.join(" "));if(this.statusCode){this.$e.addClass("btn-"+this.statusCode)}};e.prototype.makeElement=function(){var t=this;var e=$('<button type="button"></button>');e.html('<span class="pull-left">['+t.id+"]</span>"+t.text);e.on("mousedown",function(){t.notifyListeners("press")});e.on("mouseup",function(){t.notifyListeners("release")});return e};var s=function(t){this.listeners=[];this.$container=t};s.prototype.configure=function(t,e){this.baseId=e;this.buttonDefinitions=t;this.temporaryStatusTimeoutIds={};this.updateButtons();this.render()};s.prototype.clearStatus=function(t){var e=this.buttons[t];if(e){this.clearTemporaryStatus(t);e.clearStatus()}};s.prototype.render=function(){var t=$("<div></div>");t.addClass("btn-group-vertical");for(var e in this.buttons){this.buttons[e].appendTo(t)}this.$container.html("");t.appendTo(this.$container)};s.prototype.setStatus=function(t,e){var s=this.buttons[t];if(s){this.clearTemporaryStatus(t);s.setStatus(e)}};s.prototype.clearTemporaryStatus=function(t){var e=this.temporaryStatusTimeoutIds[t];if(e){clearTimeout(e);this.temporaryStatusTimeoutIds[t]=undefined}};s.prototype.setTemporaryStatus=function(t,e){this.setStatus(t,e);var s=2;var o=this;this.temporaryStatusTimeoutIds[t]=setTimeout(function(){o.clearStatus(t)},s*1e3)};s.prototype.hit=function(t,e){var s=t-this.baseId;if(e=="press"){this.notifyListeners(s)}else{this.clearStatus(s)}};s.prototype.notifyListeners=function(t){for(var e=0;e<this.listeners.length;e++){this.listeners[e](t)}};s.prototype.onHit=function(t){this.listeners.push(t)};s.prototype.getKeyIds=function(){var t=[];for(var e in this.buttons){e=parseInt(e);t.push(this.baseId+e)}return t};s.prototype.updateButtons=function(){var t=this;t.buttons={};for(var s in t.buttonDefinitions){s=parseInt(s);var o=new e(s,t.buttonDefinitions[s]);o.onHit(function(e,s){t.hit(t.baseId+e,s)});t.buttons[s]=o}};var o=function(t){this.endListeners=[];this.$element=t};o.prototype.setSources=function(t){this.sources=t};o.prototype.loadVideo=function(t){for(var e=0;e<this.sources.length;e++){var s=$("<source />").attr("src",this.sources[e].src).attr("type",this.sources[e].type);this.$element.append(s)}this.video=this.$element.get(0);this.$element.on("contextmenu",function(t){return false});this.video.oncanplaythrough=function(){t()};if(this.video.readyState>3){this.video.oncanplaythrough=null;t()}this.video.load();this.video.play();this.video.pause()};o.prototype.start=function(){this.video.play();var t=this;this.video.addEventListener("ended",function(){t.notifyEnd()},false)};o.prototype.notifyEnd=function(t){for(var e=0;e<this.endListeners.length;e++){this.endListeners[e]()}};o.prototype.onEnd=function(t){this.endListeners.push(t)};o.prototype.restart=function(){this.video.play();this.video.currentTime=0};function i(){return(new Date).getTime()}var n=function(){this.index=-1;this.cancelTimeoutId=-1;this.listeners={cancel:[],success:[]};this.startTime=0};n.prototype.configure=function(t){this.allowedError=t;this.allowedError*=1e3};n.prototype.setEvents=function(t){this.events=t};n.prototype.start=function(){this.startTime=i();this.queueNextEvent()};n.prototype.restart=function(){if(this.cancelTimeoutId!=-1){clearTimeout(this.cancelTimeoutId);this.cancelTimeoutId=-1}this.index=-1;this.start()};n.prototype.handleEvent=function(t){var e=this.getRelativeTime();var s=this.events[this.index];if(s&&t==s.id&&Math.abs(e-s.time)<=this.allowedError){this.success(t)}else{this.cancel(t)}};n.prototype.getRelativeTime=function(){return i()-this.startTime};n.prototype.queueNextEvent=function(){this.index++;if(this.index<this.events.length){var t=this.events[this.index];var e=this.getRelativeTime();var s=t.time-e+this.allowedError;if(s>0){var o=this;this.cancelTimeoutId=setTimeout(function(){o.cancel(t.id)},s)}else{console.error("could not set timeout, negative time")}}else{}};n.prototype.success=function(t){if(this.cancelTimeoutId!=-1){clearTimeout(this.cancelTimeoutId);this.cancelTimeoutId=-1;this.notifyListeners("success",t)}};n.prototype.cancel=function(t){this.notifyListeners("cancel",t)};n.prototype.notifyListeners=function(t){var e=Array.prototype.slice.call(arguments);e=e.slice(1,e.length);var s=this.listeners[t];for(var o=0;o<s.length;o++){var i=s[o];i.apply(i,e)}};n.prototype.onSuccess=function(t){this.listeners.success.push(t)};n.prototype.onCancel=function(t){this.listeners.cancel.push(t)};function r(t,e,s){$.ajax({type:"POST",url:t,contentType:"application/json",dataType:"json",data:JSON.stringify(e),success:s})}var a=function(t){this.$elements=t;this.score=0;this.highScore=-1;this.mostFailed=-1;this.averageScore=-1;this.highScoreHolder="";this.pollTimeoutId=-1;this.comboFactor=1;this.maxComboFactor=8};a.prototype.configure=function(t,e,s){this.buttonDefinitions=t;this.scoring=e;this.pollRate=s};a.prototype.setNickname=function(t){this.nickname=t};a.prototype.startPolling=function(){var t=this;var e=function(){t.load(function(){t.render();t.pollTimeoutId=setTimeout(e,t.pollRate*1e3)})};e()};a.prototype.load=function(t){var e=this;$.getJSON("/score",function(s){e.highScoreHolder=s["high_score_holder"];e.highScore=Math.floor(s["high_score"]);e.averageScore=Math.floor(s["average_score"]);e.mostFailed=Math.floor(s["most_failed"]);t()})};a.prototype.success=function(t){var e=this.scoring[t];if(e){this.score+=e*this.comboFactor;this.render()}};a.prototype.cancel=function(t){var e=this.scoring[t];r("/score",{nickname:this.nickname,final_score:this.score,failed_at:t});this.score=0;this.comboFactor=1;this.render()};a.prototype.increaseCombo=function(){this.comboFactor*=2;if(this.comboFactor>this.maxComboFactor){this.comboFactor=this.maxComboFactor}};a.prototype.render=function(){var t=this.buttonDefinitions[this.mostFailed];if(t!==undefined){this.$elements.mostFailed.text(t)}var e=this.score>this.highScore;var s=e?this.score:this.highScore;var o=e?this.nickname:this.highScoreHolder;this.$elements.highScore.attr("class","label label-as-badge");if(e){this.$elements.highScore.addClass("label-success")}else{this.$elements.highScore.addClass("label-default")}var i=s;if(o){i+=" ("+o+")"}this.$elements.highScore.text(i);var n=this.score>this.averageScore;this.$elements.averageScore.attr("class","label label-as-badge");if(n){this.$elements.averageScore.addClass("label-warning")}else{this.$elements.averageScore.addClass("label-default")}this.$elements.averageScore.text(this.averageScore);this.$elements.currentScore.attr("class","label label-as-badge");this.$elements.currentScore.text(this.score);this.$elements.currentCombo.attr("class","label label-as-badge");this.$elements.currentCombo.text(this.comboFactor)};var c=function(e){this.videoController=new o(e.video);this.controls=new s(e.controls);this.shortcuts=new t;this.eventQueue=new n;this.scoreBoard=new a(e.scoreBoardElements);var i=this;this.shortcuts.onPress(function(t){i.controls.hit(t,"press")});this.shortcuts.onRelease(function(t){i.controls.hit(t,"release")});this.shortcuts.bindTo(e.events);this.videoController.onEnd(function(){i.restartSuccessfully()});this.controls.onHit(function(t){i.eventQueue.handleEvent(t)});this.eventQueue.onSuccess(function(t){i.onSuccess(t)});this.eventQueue.onCancel(function(t){i.onCancel(t)})};c.prototype.start=function(){this.videoController.start();this.scoreBoard.startPolling();this.eventQueue.start()};c.prototype.setNickname=function(t){this.scoreBoard.setNickname(t)};c.prototype.loadSettings=function(t){var e=this;this.getSettings(function(s){e.controls.configure(s.buttonDefinitions,s.baseId);e.shortcuts.accept(e.controls.getKeyIds());e.eventQueue.configure(s.allowedError);e.eventQueue.setEvents(s.events);e.scoreBoard.configure(s.buttonDefinitions,s.scoring,s.pollRate);e.videoController.setSources(s.sources);t()})};c.prototype.restartSuccessfully=function(){this.scoreBoard.increaseCombo();this.restart()};c.prototype.restart=function(){this.videoController.restart();this.eventQueue.restart()};c.prototype.onSuccess=function(t){this.controls.setStatus(t,"success");this.scoreBoard.success(t);this.eventQueue.queueNextEvent()};c.prototype.onCancel=function(t){this.controls.setTemporaryStatus(t,"danger");this.scoreBoard.cancel(t);this.restart()};c.prototype.loadVideo=function(t){this.videoController.loadVideo(t)};c.prototype.getSettings=function(t){$.getJSON("/settings",function(e){t(e)})};$(function(){$(".btn").on("mouseup",function(){$(this).blur()});var t=new c({controls:$("#controls"),events:$(window),video:$("#video"),scoreBoardElements:{averageScore:$("#average-score"),currentCombo:$("#current-combo"),currentScore:$("#current-score"),highScore:$("#high-score"),mostFailed:$("#most-failed")}});var e=$("#loadingStep");e.show();var s=3*1e3;var o=.5*1e3;var i=.4*1e3;var n=.8*1e3;t.loadSettings(function(){e.fadeOut(i,function(){var s=$("#loginStep");s.animate({top:"0%"},n,function(){var r=$("#nickname-form");var a=$("#nickname");r.one("submit",function(r){var c=$.trim(a.val());if(!c){return false}t.setNickname(c);s.animate({top:"-100%"},n);e.fadeIn();t.loadVideo(function(){e.fadeOut(i,function(){$("#flashStep").fadeIn(i).delay(o).fadeOut(i,function(){var e=$("#gamePanel");e.fadeIn(i,function(){t.start()})})})});r.preventDefault()})})})})})})();
